#include <stdio.h>
#include <stdint.h>

#include "metrics_ecu.h"

#define METRIC_ENUM(id, ...)         METRIC_ID_ ## id
#define METRIC_NAME(id, name, ...) name
enum { METRIC_ECU_VAR_LIST(METRIC_ENUM), METRIC_VAR_NUM };
enum { METRIC_ECU_BOOL_LIST(METRIC_ENUM), METRIC_BOOL_NUM };
static const char * metric_var_names[] = { METRIC_ECU_VAR_LIST(METRIC_NAME) };
static const char * metric_bool_names[] = { METRIC_ECU_BOOL_LIST(METRIC_NAME) };
void trip_integrate_speed(unsigned val) {};
void trip_integrate_injectors(unsigned injection_time, unsigned rpm) {};

// from red obd project
#define OBD_SPEED_KMH			123
#define OBD_RPM					4567

const uint8_t obd_test_map_ecu[] = {
    (OBD_RPM / 64),						// 0x00		rpm * 4 high byte
    ((OBD_RPM % 64) * 4),				// 0x01		rpm * 4 low byte
    OBD_SPEED_KMH,						// 0x02		speed km/h
                      0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0xA1, 0x00, 0x00, 0x01,
    0x29, 0x6C, 0x30, 0x00, 0x19, 0x13, 0x00, 0x93, 0x84, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    0x83, 0x00, 0x80, 0x00, 0x02, 0x74, 0x54, 0x00, 0x17, 0x61, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x2D, 0x37, 0x00, 0x2D, 0x07, 0x2D, 0x19, 0x19, 0x19, 0x00, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0xB8, 0x10, 0x96, 0x0B, 0x10, 0x10, 0x00, 0x07, 0x00,
    0xF8, 0x00, 0xF8, 0x00, 0xF0, 0x00, 0xF8, 0xF8, 0xFC, 0xF0, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x61, 0x02, 0x00, 0x49, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const int result_metrics_bool[] = {
    [METRIC_ID_STARTER] = 0,
    [METRIC_ID_AC_BUTTON] = 0,
    [METRIC_ID_POWER_STEERING] = 0,
    [METRIC_ID_BRAKES] = 0,
    [METRIC_ID_VTEC_SENSOR] = 0,
    [METRIC_ID_SCS] = 0,
    [METRIC_ID_VTEC_CTRL] = 0,
    [METRIC_ID_MAIN_RELAY] = 1,
    [METRIC_ID_AC_CTRL] = 0,
    [METRIC_ID_O2_HEAT1] = 0,
    [METRIC_ID_CHECK_ENGINE] = 0,
    [METRIC_ID_O2_HEAT2] = 0,
    [METRIC_ID_ALTERNATOR_CTRL] = 1,
    [METRIC_ID_FAN_CTRL] = 0,
    [METRIC_ID_INTAKE_CTRL] = 0,
    [METRIC_ID_VTEC_E] = 0,
    [METRIC_ID_ECONO] = 1,
    [METRIC_ID_AT_CONTOL] = 0,
    [METRIC_ID_CLOSED_LOOP] = 0
};

const int result_metrics_real[] = {
    [METRIC_ID_RPM] = 4567,
    [METRIC_ID_ECU_SPEED] = 123,
    [METRIC_ID_ENGINE_T] = 79393,
    [METRIC_ID_INTAKE_T] = 41274,
    [METRIC_ID_INTAKE_P] = 29368,
    [METRIC_ID_ATM_P] = -5000,
    [METRIC_ID_THROTTLE] = 500,
    [METRIC_ID_OXY_1] = 370,
    [METRIC_ID_VOLTAGE_ECU] = 14066,
    [METRIC_ID_ALTERNATOR_LOAD] = 51764,
    [METRIC_ID_CURRENT] = -23448,               // какая то ерунда, в сыром значении 0xFF, как он раньше показывал 42.08 я тоже не знаю
    [METRIC_ID_ERG_VALVE_V] = 0,
    [METRIC_ID_CORR_SHORT] = -48628,
    [METRIC_ID_CORR_LONG] = -49804,
    [METRIC_ID_INJECTION] = 2512,
    [METRIC_ID_IDLING_ANGLE] = -22000,
    [METRIC_ID_IDLING_LIMIT] = -64000,
    [METRIC_ID_AIR_VALVE_POS] = 9019,
    [METRIC_ID_AIR_VALVE_CUR] = 97,
    [METRIC_ID_ERG_CTRL] = 0,
    [METRIC_ID_ERG_VALVE_POS] = 0,
    [METRIC_ID_AIR_FUEL] = 0,
    [METRIC_ID_PCS_EVAP] = 0,
    [METRIC_ID_DETONATION] = 54,
    [METRIC_ID_FUEL_SYSTEM] = 2,
    [METRIC_ID_ENGINE_LOAD] = 28627,
    [METRIC_ID_OXY_2] = 0,
    [METRIC_ID_MISF_CYL] = 0,
    [METRIC_ID_CKP_LEARN] = 0,
};


int test_result = 0;

void do_test(const char * name, int val, int expected)
{
    printf("%20s: %10d %10d", name, val, expected);
    if (val == expected) {
        printf(" - OK\n");
    } else {
        printf(" - FAIL\n");
        test_result = 1;
    }
}

int main ()
{
    for (unsigned a = 0; a < sizeof(obd_test_map_ecu); a += 16) {
        metric_ecu_data_ready(a, &obd_test_map_ecu[a], 16);
    }

    for (unsigned i = 0; i < METRIC_VAR_NUM; i++) {
        do_test(metric_var_names[i], metric_ecu_get_real(i), result_metrics_real[i]);
    }

    for (unsigned i = 0; i < METRIC_BOOL_NUM; i++) {
        do_test(metric_bool_names[i], metric_ecu_get_bool(i), result_metrics_bool[i]);
    }

    return test_result;
}
