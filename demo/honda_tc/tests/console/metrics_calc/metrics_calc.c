#include <stdio.h>
#include <stdint.h>

#include "metrics_view.h"

// from red obd project
#define OBD_SPEED_KMH			123
#define OBD_RPM					4567

const uint8_t obd_test_map_ecu[] = {
    (OBD_RPM / 64),						// 0x00		rpm * 4 high byte
    ((OBD_RPM % 64) * 4),				// 0x01		rpm * 4 low byte
    OBD_SPEED_KMH,						// 0x02		speed km/h
                      0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0xA1, 0x00, 0x00, 0x01,
    0x29, 0x6C, 0x30, 0x00, 0x19, 0x13, 0x00, 0x93, 0x84, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    0x83, 0x00, 0x80, 0x00, 0x02, 0x74, 0x54, 0x00, 0x17, 0x61, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x2D, 0x37, 0x00, 0x2D, 0x07, 0x2D, 0x19, 0x19, 0x19, 0x00, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0xB8, 0x10, 0x96, 0x0B, 0x10, 0x10, 0x00, 0x07, 0x00,
    0xF8, 0x00, 0xF8, 0x00, 0xF0, 0x00, 0xF8, 0xF8, 0xFC, 0xF0, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x61, 0x02, 0x00, 0x49, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const int result_metrics[] = {
    [METRIC_ID_STARTER] = 0,
    [METRIC_ID_AC_BUTTON] = 0,
    [METRIC_ID_POWER_STEERING] = 0,
    [METRIC_ID_BRAKES] = 0,
    [METRIC_ID_VTEC_SENSOR] = 0,
    [METRIC_ID_SCS] = 0,
    [METRIC_ID_VTEC_CTRL] = 0,
    [METRIC_ID_MAIN_RELAY] = 1,
    [METRIC_ID_AC_CTRL] = 0,
    [METRIC_ID_O2_HEAT1] = 0,
    [METRIC_ID_CHECK_ENGINE] = 0,
    [METRIC_ID_O2_HEAT2] = 0,
    [METRIC_ID_ALTERNATOR_CTRL] = 1,
    [METRIC_ID_FAN_CTRL] = 0,
    [METRIC_ID_INTAKE_CTRL] = 0,
    [METRIC_ID_VTEC_E] = 0,
    [METRIC_ID_ECONO] = 1,
    [METRIC_ID_AT_CONTOL] = 0,
    [METRIC_ID_CLOSED_LOOP] = 0,

    [METRIC_ID_RPM] = 4567,
    [METRIC_ID_ECU_SPEED] = 123,
    [METRIC_ID_ENGINE_T] = 79393,
    [METRIC_ID_INTAKE_T] = 41274,
    [METRIC_ID_INTAKE_P] = 29368,
    [METRIC_ID_ATM_P] = -5000,
    [METRIC_ID_THROTTLE] = 500,
    [METRIC_ID_OXY_1] = 370,
    [METRIC_ID_VOLTAGE_ECU] = 14066,
    [METRIC_ID_ALTERNATOR_LOAD] = 51764,
    [METRIC_ID_CURRENT] = -23448,               // какаято ерунда, в сыром значении 0xFF, как он раньше показывал 42.08 я тоже не знаю
    [METRIC_ID_ERG_VALVE_V] = 0,
    [METRIC_ID_CORR_SHORT] = -48628,
    [METRIC_ID_CORR_LONG] = -49804,
    [METRIC_ID_INJECTION] = 2512,
    [METRIC_ID_IDLING_ANGLE] = -22000,
    [METRIC_ID_IDLING_LIMIT] = -64000,
    [METRIC_ID_AIR_VALVE_POS] = 9019,
    [METRIC_ID_AIR_VALVE_CUR] = 97,
    [METRIC_ID_ERG_CTRL] = 0,
    [METRIC_ID_ERG_VALVE_POS] = 0,
    [METRIC_ID_AIR_FUEL] = 0,
    [METRIC_ID_PCS_EVAP] = 0,
    [METRIC_ID_DETONATION] = 54,
    [METRIC_ID_FUEL_SYSTEM] = 2,
    [METRIC_ID_ENGINE_LOAD] = 28627,
    [METRIC_ID_OXY_2] = 0,
    [METRIC_ID_MISF_CYL] = 0,
    [METRIC_ID_CKP_LEARN] = 0,
};

int main ()
{
    for (unsigned a = 0; a < sizeof(obd_test_map_ecu); a += 16) {
        dlc_data_ready(HONDA_UNIT_ECU, a, &obd_test_map_ecu[a], 16);
    }

    int test_result = 0;

    unsigned metric_num = metric_ecu_bool_num() + metric_ecu_var_num();

    for (unsigned i = 0; i < metric_num; i++) {
        int metric = metric_get_val(i);
        printf("%20s: %10d %10d", metric_get_name(i), metric, result_metrics[i]);
        if (metric == result_metrics[i]) {
            printf(" - OK\n");
        } else {
            printf(" - FAIL\n");
            test_result = 1;
        }
    }

    return test_result;
}
